<template>
  <v-btn-secondary
    v-if="!hydroShareConnected"
    class="mr-6"
    @click="OAuthLogin(OAuthProvider.hydroshare)"
  >
    Connect to HydroShare
  </v-btn-secondary>
  <v-btn-delete v-else class="mr-6" @click="disconnectFromHydroShare">
    Disconnect from HydroShare
  </v-btn-delete>
</template>

<script setup lang="ts">
import { useUserStore } from '@/store/user'
import { api } from '@/services/api'
import { OAuthProvider } from '@/types'
import { OAUTH_ENDPOINT } from '@/services/api'
import { storeToRefs } from 'pinia'
import { computed } from 'vue'
import { Snackbar } from '@/utils/notifications'

const { user } = storeToRefs(useUserStore())

const OAuthLogin = async (provider: OAuthProvider) => {
  let token = await api.connectToHydroShare()
  window.location.href = OAUTH_ENDPOINT(provider, token.uid, token.token)
}

async function disconnectFromHydroShare() {
  let response = await api.disconnectFromHydroShare()
  if (response === null) {
    user.value.hydroShareConnected = false
    Snackbar.info('Your HydroShare account has been disconnected.')
  }
}

const hydroShareConnected = computed(() => {
  if (!user.value) return false
  return user.value.hydroShareConnected
})
</script>
